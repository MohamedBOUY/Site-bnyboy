<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin — Messages (live)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
<div class="container">
<a class="navbar-brand" href="index.html">BNY BOY — Admin</a>
<span class="navbar-text"><small>Démo connectée à Postgres (Neon)</small></span>
</div>
</nav>

<main class="container py-4">
<div class="row g-4">
<div class="col-lg-5">
<div class="card shadow-sm">
<div class="card-body">
<h2 class="h5 mb-3">Ajouter un message</h2>
<form id="contactForm" class="vstack gap-2">
<input class="form-control" name="nom" placeholder="Nom complet" required>
<input class="form-control" type="email" name="email" placeholder="Email" required>
<textarea class="form-control" name="message" rows="4" placeholder="Message" required></textarea>
<button class="btn btn-primary w-100" type="submit">Enregistrer</button>
<div id="status" class="small mt-2 text-muted"></div>
</form>
</div>
</div>
</div>

<div class="col-lg-7">
<div class="card shadow-sm">
<div class="card-body">
<div class="d-flex align-items-center justify-content-between mb-2">
<h2 class="h5 mb-0">Messages reçus</h2>
<input id="search" class="form-control form-control-sm" style="max-width:260px" placeholder="Rechercher…">
</div>
<div class="table-responsive">
<table class="table table-sm align-middle">
<thead class="table-light">
<tr><th>Nom</th><th>Email</th><th>Message</th><th>Reçu le</th></tr>
</thead>
<tbody id="rows"><tr><td colspan="4" class="text-muted">Chargement…</td></tr></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</main>

<script>
const API = '/api/contacts';

function render(list) {
const tb = document.getElementById('rows');
tb.innerHTML = '';
for (const c of list) {
const tr = document.createElement('tr');
tr.innerHTML = `
<td>${c.nom}</td>
<td>${c.email}</td>
<td>${c.message}</td>
<td>${new Date(c.date_envoi).toLocaleString()}</td>`;
tb.appendChild(tr);
}
if (!list.length) tb.innerHTML = '<tr><td colspan="4" class="text-muted">Aucun message</td></tr>';
}

async function load() {
const res = await fetch(API);
const data = await res.json();
window.__BASE__ = data;
render(data);
}
load();

document.getElementById('search').addEventListener('input', (e) => {
const q = e.target.value.toLowerCase().trim();
const base = window.__BASE__ || [];
const filt = base.filter(c =>
c.nom.toLowerCase().includes(q) ||
c.email.toLowerCase().includes(q) ||
c.message.toLowerCase().includes(q)
);
render(filt);
});

document.getElementById('contactForm').addEventListener('submit', async (e) => {
e.preventDefault();
const f = e.target;
const status = document.getElementById('status');
status.textContent = 'Envoi…';

const payload = {
nom: f.nom.value.trim(),
email: f.email.value.trim(),
message: f.message.value.trim()
};
try {
const res = await fetch(API, {
method: 'POST',
headers: {'content-type':'application/json'},
body: JSON.stringify(payload)
});
const data = await res.json();
if (res.ok && data.ok) {
status.textContent = 'Message enregistré ✅';
f.reset();
await load();
} else {
status.textContent = 'Erreur: ' + (data.error || 'inconnue');
}
} catch {
status.textContent = 'Erreur réseau';
}
});
</script>
</body>
</html>
